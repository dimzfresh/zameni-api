name: Manual Deploy Job

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
        - development
      force_rebuild:
        description: 'Force rebuild Docker images'
        required: false
        default: false
        type: boolean

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run tests
      run: npm test
      
    - name: Build application
      run: npm run build
      
    - name: Deploy to ${{ github.event.inputs.environment }}
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd /opt/zameni-api
          git pull origin main
          
          if [ "${{ github.event.inputs.force_rebuild }}" = "true" ]; then
            echo "ğŸ”„ Force rebuilding Docker images..."
            docker-compose -f docker-compose.${{ github.event.inputs.environment }}.yml down
            docker system prune -f
            docker-compose -f docker-compose.${{ github.event.inputs.environment }}.yml up -d --build --force-recreate
          else
            docker-compose -f docker-compose.${{ github.event.inputs.environment }}.yml up -d --build
          fi
          
    - name: Health check
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          sleep 30
          curl -f https://${{ secrets.DOMAIN }}/health || exit 1
          
    - name: Notify success
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message: |
          âœ… Manual deployment successful!
          
          ğŸš€ Zameni API deployed to ${{ github.event.inputs.environment }}
          ğŸŒ Domain: ${{ secrets.DOMAIN }}
          ğŸ“š Docs: https://${{ secrets.DOMAIN }}/docs
          ğŸ’š Health: https://${{ secrets.DOMAIN }}/health
          ğŸ”„ Force rebuild: ${{ github.event.inputs.force_rebuild }}
