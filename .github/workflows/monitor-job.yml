name: Monitor Job

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # ĞšĞ°Ğ¶Ğ´Ñ‹Ğµ 6 Ñ‡Ğ°ÑĞ¾Ğ²

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
    - name: Check server health
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "ğŸ” Checking server health..."
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ´Ğ¸ÑĞº
          DISK_USAGE=$(df -h / | awk 'NR==2 {print $5}' | sed 's/%//')
          echo "ğŸ’¾ Disk usage: ${DISK_USAGE}%"
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¿Ğ°Ğ¼ÑÑ‚ÑŒ
          MEMORY_USAGE=$(free | awk 'NR==2{printf "%.1f", $3*100/$2}')
          echo "ğŸ§  Memory usage: ${MEMORY_USAGE}%"
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºÑƒ CPU
          CPU_LOAD=$(uptime | awk -F'load average:' '{print $2}' | awk '{print $1}' | sed 's/,//')
          echo "âš¡ CPU load: $CPU_LOAD"
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Docker ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ñ‹
          echo "ğŸ³ Docker containers status:"
          docker-compose -f docker-compose.production.yml ps
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ»Ğ¾Ğ³Ğ¸ Ğ½Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸
          echo "ğŸ“‹ Recent error logs:"
          docker-compose -f docker-compose.production.yml logs --tail=20 | grep -i error || echo "No errors found"
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
          if curl -f https://${{ secrets.DOMAIN }}/health > /dev/null 2>&1; then
            echo "âœ… Application is healthy"
            APP_STATUS="healthy"
          else
            echo "âŒ Application is not responding"
            APP_STATUS="unhealthy"
          fi
          
          # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ğ´Ğ»Ñ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ
          echo "DISK_USAGE=$DISK_USAGE" >> $GITHUB_ENV
          echo "MEMORY_USAGE=$MEMORY_USAGE" >> $GITHUB_ENV
          echo "CPU_LOAD=$CPU_LOAD" >> $GITHUB_ENV
          echo "APP_STATUS=$APP_STATUS" >> $GITHUB_ENV
          
    - name: Send monitoring report
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message: |
          ğŸ“Š Server Monitoring Report
          
          ğŸ–¥ï¸ Server: ${{ secrets.SERVER_HOST }}
          ğŸ’¾ Disk usage: ${{ env.DISK_USAGE }}%
          ğŸ§  Memory usage: ${{ env.MEMORY_USAGE }}%
          âš¡ CPU load: ${{ env.CPU_LOAD }}
          ğŸ’š App status: ${{ env.APP_STATUS }}
          
          ğŸŒ Domain: ${{ secrets.DOMAIN }}
          ğŸ“š Docs: https://${{ secrets.DOMAIN }}/docs
          ğŸ’š Health: https://${{ secrets.DOMAIN }}/health
          
          â° Checked at: $(date)
